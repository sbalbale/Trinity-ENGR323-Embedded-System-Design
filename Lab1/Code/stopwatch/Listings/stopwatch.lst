A51 MACRO ASSEMBLER  STOPWATCH                                                            02/19/2025 15:51:25 PAGE     1


MACRO ASSEMBLER A51 V8.2.7.0
OBJECT MODULE PLACED IN .\Objects\stopwatch.obj
ASSEMBLER INVOKED BY: C:\Keil_v5\C51\BIN\A51.EXE stopwatch.asm SET(SMALL) DEBUG PRINT(.\Listings\stopwatch.lst) OBJECT(.
                      \Objects\stopwatch.obj) EP

LOC  OBJ            LINE     SOURCE

0000                   1                 ORG     0000h           
0000 2100              2                 AJMP    MAIN           
                       3     
0013                   4                 ORG     0013h          ; External Interrupt 1 vector
0013 218F              5                 AJMP    EXT1_ISR           
                       6     
000B                   7                 ORG     000Bh          ; Timer 0 vector
000B 21A0              8                 AJMP    Timer0_ISR
                       9     
0100                  10                 ORG     0100h          
0100 758130           11     MAIN:       MOV     SP, #30h       
0103 758901           12                 MOV     TMOD, #01h     ; Timer 0, mode 1 (16-bit)
                      13     
                      14                 ; Timer 0 setup for 5ms
0106 758CEC           15                 MOV     TH0, #0ECh     
0109 758A78           16                 MOV     TL0, #078h     
                      17     
                      18                 ; Initialize registers
010C 7800             19                 MOV     R0, #00h      ; 1/100 second digit (stopwatch)
010E 7900             20                 MOV     R1, #00h      ; 1/10 second digit (stopwatch)
0110 7A00             21                 MOV     R2, #00h      ; seconds digit (stopwatch)
0112 7B00             22                 MOV     R3, #00h      ; 10 seconds digit (stopwatch)
0114 7C00             23                 MOV     R4, #00h      ; Display position
0116 7D00             24                 MOV     R5, #00h      ; Counter for 5ms intervals
0118 7E00             25                 MOV     R6, #00h     ; Mode (0=Clock, 1=Run, 2=Stop)
011A 753000           26                 MOV     30h, #00h     ; Clock seconds (ones)
011D 753100           27                 MOV     31h, #00h     ; Clock seconds (tens)
0120 753200           28                 MOV     32h, #00h     ; Clock minutes (ones)
0123 753300           29                 MOV     33h, #00h     ; Clock minutes (tens)
                      30                 
                      31                 ; Setup External Interrupt 1
0126 D28A             32                 SETB    IT1           ; Falling edge triggered
0128 D2AA             33                 SETB    EX1           ; Enable INT1
                      34                 
                      35                 ; Enable display refresh timer
012A D2A9             36                 SETB    ET0           ; Enable Timer 0
012C D2AF             37                 SETB    EA            ; Enable global interrupts
012E D28C             38                 SETB    TR0           ; Start Timer 0
                      39     
0130                  40     MainLoop:   ; Check if 1 second has elapsed (clock)
0130 ED               41                 MOV     A, R5
0131 B4C82A           42                 CJNE    A, #0C8h, Check_Stopwatch  ; Wait for 200 * 5ms
0134 7D00             43                 MOV     R5, #00h      ; Reset counter
                      44     
                      45                 ; Update clock seconds
0136 0530             46                 INC     30h           ; Increment ones second
0138 E530             47                 MOV     A, 30h
013A B40A21           48                 CJNE    A, #0Ah, Check_Stopwatch
013D 753000           49                 MOV     30h, #00h     ; Reset ones second
                      50                 
                      51                 ; Update tens seconds
0140 0531             52                 INC     31h           ; Increment tens seconds
0142 E531             53                 MOV     A, 31h
0144 B40617           54                 CJNE    A, #06h, Check_Stopwatch
0147 753100           55                 MOV     31h, #00h     ; Reset tens seconds
                      56                 
                      57                 ; Update minutes
A51 MACRO ASSEMBLER  STOPWATCH                                                            02/19/2025 15:51:25 PAGE     2

014A 0532             58                 INC     32h           ; Increment minutes
014C E532             59                 MOV     A, 32h
014E B40A0D           60                 CJNE    A, #0Ah, Check_Stopwatch
0151 753200           61                 MOV     32h, #00h     ; Reset minutes
                      62                 
                      63                 ; Update tens minutes
0154 0533             64                 INC     33h           ; Increment tens minutes
0156 E533             65                 MOV     A, 33h
0158 B40603           66                 CJNE    A, #06h, Check_Stopwatch
015B 753300           67                 MOV     33h, #00h     ; Reset tens minutes
                      68     
015E                  69     Check_Stopwatch:
                      70                 ; Check current mode
015E EE               71                 MOV     A, R6
015F B401CE           72                 CJNE    A, #01h, MainLoop  ; If not mode 1, skip stopwatch
                      73     
                      74                 ; Update stopwatch
0162 ED               75                 MOV     A, R5
0163 B402CA           76                 CJNE    A, #02h, MainLoop  ; Wait for 10ms (2 * 5ms)
0166 7D00             77                 MOV     R5, #00h     ; Reset MS counter
                      78     
                      79                 ; Update stopwatch digits
0168 08               80                 INC     R0           ; 1/100 seconds
0169 E8               81                 MOV     A, R0
016A B40AC3           82                 CJNE    A, #0Ah, MainLoop
016D 7800             83                 MOV     R0, #00h
                      84                 
016F 09               85                 INC     R1           ; 1/10 seconds
0170 E9               86                 MOV     A, R1
0171 B40ABC           87                 CJNE    A, #0Ah, MainLoop
0174 7900             88                 MOV     R1, #00h
                      89                 
0176 0A               90                 INC     R2           ; Seconds
0177 EA               91                 MOV     A, R2
0178 B40AB5           92                 CJNE    A, #0Ah, MainLoop
017B 7A00             93                 MOV     R2, #00h
                      94                 
017D 0B               95                 INC     R3           ; 10 seconds
017E EB               96                 MOV     A, R3
017F B406AE           97                 CJNE    A, #06h, MainLoop  ; Max 59.99 seconds
0182 7B00             98                 MOV     R3, #00h
                      99                 
0184 80AA            100                 SJMP    MainLoop
                     101                
                     102     ; 1ms delay routine
0186 7FC7            103     MSECDelay:  MOV     R7, #0C7h    ; 199 * 1us = 1ms
0188 1F              104     BackA:      DEC     R7
0189 00              105                 NOP
018A 00              106                 NOP
018B BF00FA          107                 CJNE    R7, #000h, BackA
018E 22              108                 RET
                     109     
                     110     ; External Interrupt 1 ISR - Toggle modes
018F C0E0            111     EXT1_ISR:   PUSH    ACC
0191 C0D0            112                 PUSH    PSW
                     113                 
0193 EE              114                 MOV     A, R6        ; Get current mode
0194 04              115                 INC     A             ; Next mode
0195 B40302          116                 CJNE    A, #03h, Save_Mode
0198 7400            117                 MOV     A, #00h       ; Wrap to mode 0
019A FE              118     Save_Mode:  MOV     R6, A
                     119                 
019B D0D0            120                 POP     PSW
019D D0E0            121                 POP     ACC
019F 32              122                 RETI
                     123     
A51 MACRO ASSEMBLER  STOPWATCH                                                            02/19/2025 15:51:25 PAGE     3

                     124     ; Timer 0 ISR - Display refresh only
01A0 C0E0            125     Timer0_ISR: PUSH    ACC            
01A2 C0D0            126                 PUSH    PSW
                     127     
                     128                 ; Reload timer for next 5ms
01A4 C28C            129                 CLR     TR0            
01A6 758CEC          130                 MOV     TH0, #0ECh     
01A9 758A8C          131                 MOV     TL0, #08Ch     
01AC C28D            132                 CLR     TF0            
01AE D28C            133                 SETB    TR0            
                     134     
                     135                 ; Increment 5ms counter
01B0 0D              136                 INC     R5            
                     137     
                     138                 ; Select display based on mode
01B1 EE              139                 MOV     A, R6
01B2 7020            140                 JNZ     Show_Stopwatch
                     141     
01B4 EC              142     Show_Clock: MOV     A, R4          
01B5 B40004          143                 CJNE    A, #00h, Clock_Pos1
01B8 E533            144                 MOV     A, 33h         ; Display 10 minutes
01BA 8032            145                 SJMP    Output_Digit
                     146     
01BC B40106          147     Clock_Pos1: CJNE    A, #01h, Clock_Pos2
01BF E532            148                 MOV     A, 32h         ; Display 1 minute
01C1 4410            149                 ORL     A, #10h        
01C3 8029            150                 SJMP    Output_Digit
                     151     
01C5 B40206          152     Clock_Pos2: CJNE    A, #02h, Clock_Pos3
01C8 E531            153                 MOV     A, 31h         ; Display 10 seconds
01CA 4420            154                 ORL     A, #20h        
01CC 8020            155                 SJMP    Output_Digit
                     156     
01CE E530            157     Clock_Pos3: MOV     A, 30h         ; Display 1 second
01D0 4430            158                 ORL     A, #30h        
01D2 801A            159                 SJMP    Output_Digit
                     160     
01D4                 161     Show_Stopwatch:
01D4 EC              162                 MOV     A, R4          
01D5 B40003          163                 CJNE    A, #00h, Stop_Pos1
01D8 EB              164                 MOV     A, R3          ; 10 seconds
01D9 8013            165                 SJMP    Output_Digit
                     166     
01DB B40105          167     Stop_Pos1:  CJNE    A, #01h, Stop_Pos2
01DE EA              168                 MOV     A, R2          ; Seconds
01DF 4410            169                 ORL     A, #10h        
01E1 800B            170                 SJMP    Output_Digit
                     171     
01E3 B40205          172     Stop_Pos2:  CJNE    A, #02h, Stop_Pos3
01E6 E9              173                 MOV     A, R1          ; 1/10 second
01E7 4420            174                 ORL     A, #20h        
01E9 8003            175                 SJMP    Output_Digit
                     176     
01EB E8              177     Stop_Pos3:  MOV     A, R0          ; 1/100 second
01EC 4430            178                 ORL     A, #30h        
                     179     
01EE                 180     Output_Digit:
01EE F590            181                 MOV     P1, A          
                     182     
                     183                 ; Update display position
01F0 EC              184                 MOV     A, R4
01F1 04              185                 INC     A              
01F2 B40402          186                 CJNE    A, #04h, Save_Pos
01F5 7400            187                 MOV     A, #00h      
                     188                   
01F7 FC              189     Save_Pos:   MOV     R4, A         
A51 MACRO ASSEMBLER  STOPWATCH                                                            02/19/2025 15:51:25 PAGE     4

                     190     
01F8 D0D0            191                 POP     PSW            
01FA D0E0            192                 POP     ACC
01FC 32              193                 RETI
                     194     
                     195                 END
A51 MACRO ASSEMBLER  STOPWATCH                                                            02/19/2025 15:51:25 PAGE     5

SYMBOL TABLE LISTING
------ ----- -------


N A M E             T Y P E  V A L U E   ATTRIBUTES

ACC. . . . . . . .  D ADDR   00E0H   A   
BACKA. . . . . . .  C ADDR   0188H   A   
CHECK_STOPWATCH. .  C ADDR   015EH   A   
CLOCK_POS1 . . . .  C ADDR   01BCH   A   
CLOCK_POS2 . . . .  C ADDR   01C5H   A   
CLOCK_POS3 . . . .  C ADDR   01CEH   A   
EA . . . . . . . .  B ADDR   00A8H.7 A   
ET0. . . . . . . .  B ADDR   00A8H.1 A   
EX1. . . . . . . .  B ADDR   00A8H.2 A   
EXT1_ISR . . . . .  C ADDR   018FH   A   
IT1. . . . . . . .  B ADDR   0088H.2 A   
MAIN . . . . . . .  C ADDR   0100H   A   
MAINLOOP . . . . .  C ADDR   0130H   A   
MSECDELAY. . . . .  C ADDR   0186H   A   
OUTPUT_DIGIT . . .  C ADDR   01EEH   A   
P1 . . . . . . . .  D ADDR   0090H   A   
PSW. . . . . . . .  D ADDR   00D0H   A   
SAVE_MODE. . . . .  C ADDR   019AH   A   
SAVE_POS . . . . .  C ADDR   01F7H   A   
SHOW_CLOCK . . . .  C ADDR   01B4H   A   
SHOW_STOPWATCH . .  C ADDR   01D4H   A   
SP . . . . . . . .  D ADDR   0081H   A   
STOP_POS1. . . . .  C ADDR   01DBH   A   
STOP_POS2. . . . .  C ADDR   01E3H   A   
STOP_POS3. . . . .  C ADDR   01EBH   A   
TF0. . . . . . . .  B ADDR   0088H.5 A   
TH0. . . . . . . .  D ADDR   008CH   A   
TIMER0_ISR . . . .  C ADDR   01A0H   A   
TL0. . . . . . . .  D ADDR   008AH   A   
TMOD . . . . . . .  D ADDR   0089H   A   
TR0. . . . . . . .  B ADDR   0088H.4 A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
